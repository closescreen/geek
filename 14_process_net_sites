#!/usr/bin/env bash
#> Making table "bids" for net_sites (tn0).

#>> in (from tn0 total.gz):
# для net_sites биды - это все просмотры, сетевые и не сетевые

lae -lb="uid second sz pz bt exposureprice secondprice divexpsecond ad network dom path sestart isview" '
my ( %bids, %positive_bids, %dom );
_{
 $bids{ $F[SZ] }{ $F[AD] }{ $F[EXPOSUREPRICE]>0||0 }{ $F[NETWORK]>0||0 }++;
 $dom{ $F[SZ] } ||= $F[DOM];
};

for my $sz ( sort {$a<=>$b} keys %bids ){
    for my $ad ( sort {$a<=>$b} keys %{$bids{$sz}} ){
	for my $is_posibid ( sort {$a<=>$b} keys %{ $bids{$sz}{$ad} } ){
	    for my $is_network ( sort {$a<=>$b} keys %{ $bids{$sz}{$ad}{$is_posibid} } ){
		p0 $sz, $ad, $is_posibid, $is_network, $bids{ $sz }{ $ad }{ $is_posibid }{ $is_network }, $dom{ $sz };
	    }	
	}
    }
}

' 

#>> OUT: sz, ad, is_posibid, is_network, bids, domain.
#>> 
#>> | field  | description |
#>> | ------ | ----------- |
#>> | sz     |
#>> | ad     |
#>> | is_posibid | ставки >0 |
#>> | is_network | сетевые показы (выинранные биды) |
#>> | bids   | количество бидов |
#>> | domain | домен (как внешний ключ для объединения с данными, сгруппированными по доменам ) |

#>> сортировака -n -k1,1 -k2,2 -k3,3 -k4,4

