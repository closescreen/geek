#!/usr/bin/env bash
#> history_log -------( jobscript )--------> ../RESULT/10/${day}/${job}/${typenum}/yyyy-mm-ddThh.gz
#>> Сбор часовых данных из hl.
#> Параметры: $job и $typenum.

(
set -u
set +x
set -o pipefail
cd `dirname $0`

job=${1:?JOB!} # google | net-forty-three, ...
typenum=${2:?TYPENUM!} # 0|1|3

action=$( href -dict="ssp_sites => 'scp dm10.adriver.x:/work/data/share3/DATA/dicts/ssp_sites.txt ./ssp_sites.txt' " -val=$job )
[[ -n "$action" ]] && eval $action

sids=$( href -dict="
    ssp_sites=>\"`cat ssp_sites.txt | words -fu=sortnu -ot='|'`\",
    google=>187537,
    " -val="$job"
)

#>: Каждой комбинации $job и $typenum соответствует свой скрипт сбора.
jobscript="./10_${job}_tn${typenum}"

chk "$jobscript" "Job script" "-x" "exists and executable" noprint || exit 2

#> Если присутствует total.gz то часовые данные не собираются.
#> Часы группируются в папки по суткам с 04.00 до 04.00.

#>: период, за который собрать данные (если их еще нет)
period="30days" 

hours -t=todayT04 -n=-"$period" -r |
files "../RESULT/10/%( hours -t=%f -n=-4 -first -day )/$job/$typenum/%FT%H.gz" |
only --without="total.gz" |
washing -time=10.time.log -v_flag="$jobscript %f \"$sids\"" -comp=gzip

)>>"$0.log" 2>&1
