#!/usr/bin/env bash
#> Запуск всех скриптов.

export PATH=$PATH:/usr/local/rle/var/bike
export PERL5LIB=/home/d.belyaev/perl5/lib/perl5
export PATH=$PATH:/usr/local/rle/bin
export SCALA_HOME=$HOME/scala-2.11.2
export PATH=$SCALA_HOME/bin:$PATH

(
set -u
set +x
set -o pipefail
cd `dirname $0`

force_start=${1:-""} # можно указать "force"

[[ -s 01_STOP_ALL.stop ]] && echo "01_STOP_ALL.stop found! Remove it and try again.">&2 && exit 1

jobs="google net_sites"
typenums="0 1 3"

# запуск только при низком loadaverage или при "force"
[[ -z "$force_start" ]] && loadaverage -1m -gt 4 && echo "$(date +"%F %H:%M") loadaverage too big ($(loadaverage -1m))">&2 && exit
echo "Started at $(date +"%F %H:%M")" >&2 # debug for view log

proc_num=3 # count of parallel processes at time

do_it ()  { local pf=$1; local cmd=$2; fork -pf=$pf -single "$cmd" -wait; }

for proc in `seq 1 "$proc_num"`; do
    (
    
    pf="../pids/$proc.pids"
    
    do_it "../pids/singleton.pids" "nice ./32_COPY_TRAITS"
    do_it "../pids/singleton.pids" "nice ./35_DOM_NET"
    do_it "../pids/singleton.pids" "nice ./37_VIEWS"
    do_it "../pids/singleton.pids" "nice ./95_REMOVE"
    
    for job in $jobs;do

	do_it "$pf" "nice ./55_SZGR $job"
	do_it "$pf" "nice ./51_SZVARS_30DAYS $job"
	do_it "$pf" "nice ./33_TRAITS $job"
	do_it "$pf" "nice ./27_URLGR_DIFF $job"
	do_it "$pf" "nice ./25_URLGR $job"
	do_it "$pf" "nice ./22_DOMGR7DAYS $job"
	do_it "$pf" "nice ./21_DOMGR $job"
	do_it "$pf" "nice ./20_DOM30DAYS $job"
	do_it "$pf" "nice ./19_URLS30DAYS $job"
	do_it "$pf" "nice ./18_UIDSZ $job"
	do_it "$pf" "nice ./17_URLS $job"
	do_it "$pf" "nice ./16_PZBT $job"
	do_it "$pf" "nice ./15_SESSIONS $job"
	do_it "$pf" "nice ./14_BIDS $job"

	for typenum in $typenums; do
	    do_it "$pf" "nice ./12_MERGE $job $typenum"
	    do_it "$pf" "nice ./10_HOURS $job $typenum"
	done
	
    done
    ) &
done
)>>"$0.log" 2>&1
