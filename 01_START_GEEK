#!/usr/bin/env bash
#> Запуск всех скриптов.

export PATH=$PATH:/usr/local/rle/var/bike
export PERL5LIB=/home/d.belyaev/perl5/lib/perl5
export PATH=$PATH:/usr/local/rle/bin
export SCALA_HOME=$HOME/scala-2.11.2
export PATH=$SCALA_HOME/bin:$PATH

(
set -u
set +x
set -o pipefail
cd `dirname $0`

[[ -s 01_STOP_ALL.stop ]] && echo "01_STOP_ALL.stop found! Remove it and try again.">&2 && exit 1

# запуск только при низком loadaverage или при "force"
loadaverage -1m -gt 4 && echo "$(date +"%F %H:%M") loadaverage too big ($(loadaverage -1m))">&2 && exit
echo "Started at $(date +"%F %H:%M")" >&2 # debug for view log

target_date="2015-01-12"

proc=3 # count of parallel processes at time
for job in net_sites google ssp_sites; do
    tn=`href -dict="net_sites=>0, google=>3, ssp_sites=>3" -val=$job`
    target=../RESULT/10/$target_date/$job/$tn/clust_sz_1.txt

    ./95_REMOVE_EMPTY $job;
    ./95_REMOVE_OLD_HOURS $job;
    cmd="nice ./00_geek4 --no_warn_deep --want=$target; "
    fork -pf=../pids/common.pids -n=$proc "$cmd"
done


)>>"$0.log" 2>&1
