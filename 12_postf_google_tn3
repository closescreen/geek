#!/usr/bin/env bash
#> добавляем колонку про сессии: СЕКУНДЫ начала сессии КУКИ на САЙТЗОНЕ, 
#> и колонку "признак засчитываемого просмотра страницы" - незасчитываются повторные просмотры одной и тойже страницы с интервалом менее 10 сук.
#> На входе поток за сутки (т.е период начало и конец которого можно считать разрывом сессии), лучше с 04-00 по 04-00.
#> отсортрованный по САЙТЗОНЕ, КУКЕ и ВРЕМЕНИ. 

lae -lb="sz uid second pz bt exposureprice ref +sestart +isview" '
my $sestart=0;
my %last_view;
my $prevExpSec = 0;
_{

    #> Сессию (куки на сайтзоне) считаем законченной если:
    session_break( prevSz, prevUid ) if
    
	#> если сменилась сайтзона:
	( prevSz and Sz!=prevSz )

	#> или если сменилась кука:
	or  ( prevUid ne "" and Uid!=prevUid )
    
	#> или если после последнего просмотра на данной сайтзоне времени прошло больше 30 минут:
	or  ( $prevExpSec and ( Second - $prevExpSec )>1800 );
 
    # Если нет секунды начала, значит началом сессии считаем текущую секунду:
    set_sestart( $sestart ||= Second );
 
    # Просмотром считаем просмотр, если данный непустой referer не просматривался менее 10 сек назад:
    if ( &Ref and ( 
		not exists $last_view{ &Ref } 
		or (Second - $last_view{ &Ref }) > 10 
    )){
	set_isview(1);
    }else{
	set_isview(0); # <-----p0 будет печатать 0 где undef попробовать удалить строку, посмотреть прирост производительности
    }
 
    # Запоминаем, что и когда на этой сайтзоне просматривала кука в последний раз:
    if ( Ref ){
	$last_view{ &Ref } = Second
    }
 

 #>> OUT: sz uid second pz bt exposureprice ref sestart isview  

 p0 @F;

 $prevExpSec = Second; # храним время предыдущего просмотра
} -prev=>"sz=0,uid,second=0";


sub session_break{
 # разрыв сессии куки на сайтзоне.
 # Это значит, что для куки-сайтзоны, для которых закончилась сессия перестаем хранить, что хранили:
 undef $sestart;
 undef %last_view; 
}

'
